<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Atrasos - UEPDC</title>
  
  <!-- Favicon del colegio -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/wNhQpyX0/image-30.png" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (icons) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>
  <script>
    // Forzar carga de iconos
    window.addEventListener('load', () => {
      if (window.lucide) window.lucide.replace();
    });
  </script>

  <!-- jsQR (QR scanning) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    html,body,#root { height: 100%; margin: 0; }
    
    /* Colores institucionales */
    :root {
      --primary-blue: #1976D2;
      --primary-blue-dark: #0D47A1;
      --primary-blue-light: #2196F3;
      --primary-yellow: #FFC107;
      --primary-yellow-dark: #FFA000;
      --primary-yellow-light: #FFD54F;
    }

    /* ANIMACIONES */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }

    .animate-slideIn {
      animation: slideIn 0.5s ease-out;
    }

    .animate-pulse-slow {
      animation: pulse 2s ease-in-out infinite;
    }

    .animate-bounce-slow {
      animation: bounce 2s ease-in-out infinite;
    }

    .animate-shimmer {
      animation: shimmer 2s linear infinite;
      background: linear-gradient(to right, #10b981 0%, #34d399 50%, #10b981 100%);
      background-size: 1000px 100%;
    }

    /* Hover effects */
    .hover-scale {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .hover-scale:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .hover-glow {
      transition: box-shadow 0.3s ease;
    }

    .hover-glow:hover {
      box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
    }

    .bg-institutional-blue { background-color: var(--primary-blue); }
    .bg-institutional-blue-dark { background-color: var(--primary-blue-dark); }
    .bg-institutional-yellow { background-color: var(--primary-yellow); }
    .text-institutional-blue { color: var(--primary-blue); }
    .text-institutional-yellow { color: var(--primary-yellow); }
    .border-institutional-blue { border-color: var(--primary-blue); }
    .border-institutional-yellow { border-color: var(--primary-yellow); }

    .file-upload-zone {
      border: 2px dashed #1976D2;
      transition: all 0.3s ease;
    }
    
    .file-upload-zone:hover {
      border-color: #FFC107;
      background-color: #FFFEF7;
      transform: scale(1.02);
    }

    .file-upload-zone.drag-over {
      border-color: #FFC107;
      background-color: #FFF9C4;
      transform: scale(1.05);
    }

    /* Logo responsive */
    .logo-container {
      width: 60px;
      height: 60px;
      transition: transform 0.3s ease;
    }

    .logo-container:hover {
      transform: rotate(5deg) scale(1.1);
    }

    /* Efectos de tabla */
    tbody tr {
      transition: all 0.3s ease;
    }

    tbody tr:hover {
      transform: translateX(5px);
    }

    /* Loading spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    /* Estilo mejorado para "Ya Justificado" */
    .justified-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4), 0 0 40px rgba(16, 185, 129, 0.2);
      position: relative;
      overflow: hidden;
    }

    .justified-badge::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: rotate(45deg);
      animation: shimmer 3s linear infinite;
    }

    .justified-badge-icon {
      background: rgba(255, 255, 255, 0.95);
      animation: pulse 2s ease-in-out infinite;
    }

    /* Estilo para las secciones del formulario */
    .form-section-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--primary-blue);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Logo URL desde internet
    const LOGO_URL = "https://i.ibb.co/wNhQpyX0/image-30.png";

    // Supabase
    const SUPABASE_URL = 'https://ebfknrtbfszjmnnhoxwe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViZmtucnRiZnN6am1ubmhveHdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NTg0NTgsImV4cCI6MjA3OTEzNDQ1OH0.eWgaIfmi7eFs7evpWfflm_MtXH8Ma9LA5s997hR1HGY';

    // Usuarios autorizados para inspecci√≥n
    const AUTHORIZED_USERS = [
      { email: 'ricardobravo@uepdc.edu.ec', password: 'inspeccion2025', nombre: 'Ricardo Bravo', nombreCompleto: 'BRAVO RIVERA RICARDO ISAAC' },
      { email: 'angelamartinez@uepdc.edu.ec', password: 'inspeccion2025', nombre: 'Angela Martinez', nombreCompleto: 'MARTINEZ ZAMBRANO ANGELA VICTORIA' }
    ];

    // Estructura de cursos completa con paralelos disponibles
    const CURSOS_ESTRUCTURA = {
      inicial: {
        nombre: 'üé® INICIAL',
        cursos: {
          'Inicial 1': { paralelos: ['A'], formatoDB: 'Inicial 1 {paralelo} - Inicial' },
          'Inicial 2': { paralelos: ['A', 'B'], formatoDB: 'Inicial 2 {paralelo} - Inicial' }
        }
      },
      escuela: {
        nombre: 'üéí ESCUELA (1ro - 7mo EGB)',
        cursos: {
          '1ro EGB': { paralelos: ['A', 'B'], formatoDB: 'Primer Grado {paralelo} - Preparatoria' },
          '2do EGB': { paralelos: ['A', 'B'], formatoDB: 'Segundo Grado {paralelo} - Educaci√≥n General B√°sica' },
          '3ro EGB': { paralelos: ['A', 'B'], formatoDB: 'Tercer Grado {paralelo} - Educaci√≥n General B√°sica' },
          '4to EGB': { paralelos: ['A', 'B'], formatoDB: 'Cuarto Grado {paralelo} - Educaci√≥n General B√°sica' },
          '5to EGB': { paralelos: ['A', 'B'], formatoDB: 'Quinto Grado {paralelo} - Educaci√≥n General B√°sica' },
          '6to EGB': { paralelos: ['A', 'B'], formatoDB: 'Sexto Grado {paralelo} - Educaci√≥n General B√°sica' },
          '7mo EGB': { paralelos: ['A'], formatoDB: 'S√©ptimo Grado {paralelo} - Educaci√≥n General B√°sica' }
        }
      },
      basica: {
        nombre: 'üìñ B√ÅSICA SUPERIOR (8vo - 10mo EGB)',
        cursos: {
          '8vo EGB': { paralelos: ['A', 'B', 'C'], formatoDB: 'Octavo Grado {paralelo} - Educaci√≥n General B√°sica' },
          '9no EGB': { paralelos: ['A', 'B', 'C'], formatoDB: 'Noveno Grado {paralelo} - Educaci√≥n General B√°sica' },
          '10mo EGB': { paralelos: ['A', 'B', 'C'], formatoDB: 'D√©cimo Grado {paralelo} - Educaci√≥n General B√°sica' }
        }
      },
      bachillerato: {
        nombre: 'üéì BACHILLERATO',
        cursos: {
          '1ro BGU': {
            especialidades: {
              'BGU Ciencias': { paralelos: ['A', 'B'], formatoDB: 'Primer A√±o BGU {paralelo} - Bachillerato CIENCIAS' },
              'TICS Inform√°tica': { paralelos: ['A'], formatoDB: 'Primer A√±o BGU T√©cnico Area T√©cnica TICs {paralelo} - Bachillerato INFORMATICA' },
              'BGU Contable': { paralelos: ['A'], formatoDB: 'Primer A√±o BGU T√©cnico Area T√©cnica de Servicios {paralelo} - Bachillerato CONTABILIDAD' }
            }
          },
          '2do BGU': {
            especialidades: {
              'BGU Ciencias': { paralelos: ['A', 'B'], formatoDB: 'Segundo A√±o BGU {paralelo} - Bachillerato CIENCIAS' },
              'TICS Inform√°tica': { paralelos: ['A'], formatoDB: 'Segundo A√±o BGU T√©cnico Area T√©cnica TICs {paralelo} - Bachillerato INFORMATICA' },
              'BGU Contable': { paralelos: ['A'], formatoDB: 'Segundo A√±o BGU T√©cnico Area T√©cnica de Servicios {paralelo} - Bachillerato CONTABILIDAD' }
            }
          },
          '3ro BGU': {
            especialidades: {
              'BGU Ciencias': { paralelos: ['A', 'B'], formatoDB: 'Tercer A√±o BGU {paralelo} - Bachillerato CIENCIAS' },
              'TICS Inform√°tica': { paralelos: ['A', 'B'], formatoDB: 'Tercer A√±o BGU T√©cnico Area T√©cnica TICs {paralelo} - Bachillerato INFORMATICA' },
              'BGU Contable': { paralelos: ['A'], formatoDB: 'Tercer A√±o BGU T√©cnico Area T√©cnica de Servicios {paralelo} - Bachillerato CONTABILIDAD' }
            }
          }
        }
      }
    };

    // Funci√≥n para obtener fecha y hora en Ecuador (UTC-5)
    const getEcuadorDateTime = () => {
      const now = new Date();
      const ecuadorOffset = -5 * 60 * 60 * 1000;
      const localOffset = now.getTimezoneOffset() * 60 * 1000;
      const ecuadorTime = new Date(now.getTime() + localOffset + ecuadorOffset);
      
      return {
        date: ecuadorTime,
        dateString: ecuadorTime.getFullYear() + '-' + 
                    String(ecuadorTime.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(ecuadorTime.getDate()).padStart(2, '0'),
        timeString: String(ecuadorTime.getHours()).padStart(2, '0') + ':' + 
                    String(ecuadorTime.getMinutes()).padStart(2, '0'),
        displayDate: String(ecuadorTime.getDate()).padStart(2, '0') + '/' + 
                     String(ecuadorTime.getMonth() + 1).padStart(2, '0') + '/' + 
                     ecuadorTime.getFullYear()
      };
    };

    // Funci√≥n para normalizar nombres
    const normalizeName = (name) => {
      if (!name) return '';
      return name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    };

    // Funci√≥n para verificar si dos nombres coinciden
    const namesMatch = (name1, name2) => {
      if (!name1 || !name2) return false;
      
      const normalized1 = normalizeName(name1);
      const normalized2 = normalizeName(name2);
      
      if (normalized1 === normalized2) return true;
      
      const words1 = normalized1.split(' ').filter(w => w.length > 2);
      const words2 = normalized2.split(' ').filter(w => w.length > 2);
      
      const matchingWords = words1.filter(w1 => words2.some(w2 => w1 === w2 || w1.includes(w2) || w2.includes(w1)));
      
      return matchingWords.length >= 2;
    };

    const supabaseRequest = async (endpoint, method = 'GET', body = null) => {
      const options = {
        method,
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        }
      };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);
      if (!res.ok) {
        let errText = 'Error en la petici√≥n';
        try { const j = await res.json(); errText = j.message || j.error || errText; } catch {}
        throw new Error(errText);
      }
      return res.json();
    };

    // FileUpload Component (SOLO para justificaci√≥n)
    function FileUpload({ onFileSelect, selectedFile }) {
      const [isDragging, setIsDragging] = useState(false);
      const fileInputRef = useRef(null);

      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragging(true);
      };

      const handleDragLeave = () => {
        setIsDragging(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer.files[0];
        if (file) onFileSelect(file);
      };

      const handleFileChange = (e) => {
        const file = e.target.files?.[0];
        if (file) onFileSelect(file);
      };

      useEffect(() => { if (window.lucide) window.lucide.replace(); }, [selectedFile]);

      return (
        <div className="animate-fadeIn">
          <label className="block text-sm font-semibold text-gray-700 mb-2">
            Adjuntar Evidencia (Opcional)
          </label>
          <div
            className={`file-upload-zone rounded-lg p-6 text-center cursor-pointer ${isDragging ? 'drag-over' : ''}`}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            onClick={() => fileInputRef.current?.click()}
          >
            <input
              ref={fileInputRef}
              type="file"
              onChange={handleFileChange}
              className="hidden"
              accept="image/*,.pdf,.doc,.docx"
            />
            
            {selectedFile ? (
              <div className="flex items-center justify-center gap-3 animate-slideIn">
                <i data-lucide="file-check" style={{width:24,height:24}} className="text-institutional-blue"></i>
                <div className="text-left">
                  <p className="font-semibold text-institutional-blue">{selectedFile.name}</p>
                  <p className="text-sm text-gray-500">{(selectedFile.size / 1024).toFixed(2)} KB</p>
                </div>
                <button
                  onClick={(e) => { e.stopPropagation(); onFileSelect(null); }}
                  className="text-red-500 hover:text-red-700 p-1 hover-scale"
                >
                  <i data-lucide="x" style={{width:20,height:20}}></i>
                </button>
              </div>
            ) : (
              <div className="animate-bounce-slow">
                <i data-lucide="upload-cloud" style={{width:40,height:40}} className="mx-auto mb-3 text-institutional-blue"></i>
                <p className="text-institutional-blue font-semibold mb-1">
                  Arrastra un archivo aqu√≠
                </p>
                <p className="text-sm text-gray-500">
                  o haz clic para seleccionar
                </p>
                <p className="text-xs text-gray-400 mt-2">
                  Formatos: PDF, DOC, DOCX, Im√°genes
                </p>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Login Component
    function Login({ onLogin }) {
      const [userType, setUserType] = useState('estudiante');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      
      const [nombreCompleto, setNombreCompleto] = useState('');
      const [cedula, setCedula] = useState('');
      const [nivelEducativo, setNivelEducativo] = useState('');
      const [anoGrado, setAnoGrado] = useState('');
      const [especialidad, setEspecialidad] = useState('');
      const [paralelo, setParalelo] = useState('');
      const [showRegister, setShowRegister] = useState(false);

      // Obtener opciones de a√±o/grado seg√∫n nivel educativo
      const getAnoGradoOptions = () => {
        if (!nivelEducativo) return [];
        const nivel = CURSOS_ESTRUCTURA[nivelEducativo];
        if (!nivel) return [];
        return Object.keys(nivel.cursos);
      };

      // Obtener paralelos disponibles seg√∫n el a√±o/grado y especialidad
      const getParalelosDisponibles = () => {
        if (!nivelEducativo || !anoGrado) return [];
        
        const nivel = CURSOS_ESTRUCTURA[nivelEducativo];
        if (!nivel) return [];
        
        const curso = nivel.cursos[anoGrado];
        if (!curso) return [];
        
        // Si es bachillerato y tiene especialidades
        if (curso.especialidades) {
          if (!especialidad) return [];
          const esp = curso.especialidades[especialidad];
          return esp ? esp.paralelos : [];
        }
        
        // Para otros niveles sin especialidades
        return curso.paralelos || [];
      };

      // Obtener especialidades disponibles (solo para bachillerato)
      const getEspecialidadesDisponibles = () => {
        if (nivelEducativo !== 'bachillerato' || !anoGrado) return [];
        
        const nivel = CURSOS_ESTRUCTURA.bachillerato;
        const curso = nivel.cursos[anoGrado];
        
        if (!curso || !curso.especialidades) return [];
        return Object.keys(curso.especialidades);
      };

      // Construir el curso completo en formato de base de datos
      const construirCursoCompleto = () => {
        if (!nivelEducativo || !anoGrado || !paralelo) return '';
        
        const nivel = CURSOS_ESTRUCTURA[nivelEducativo];
        if (!nivel) return '';
        
        const curso = nivel.cursos[anoGrado];
        if (!curso) return '';
        
        // Si es bachillerato con especialidades
        if (curso.especialidades && especialidad) {
          const esp = curso.especialidades[especialidad];
          if (!esp) return '';
          return esp.formatoDB.replace('{paralelo}', paralelo);
        }
        
        // Para otros niveles
        if (curso.formatoDB) {
          return curso.formatoDB.replace('{paralelo}', paralelo);
        }
        
        return '';
      };

      // Resetear campos cuando cambia el nivel educativo o a√±o/grado
      useEffect(() => {
        setAnoGrado('');
        setEspecialidad('');
        setParalelo('');
      }, [nivelEducativo]);

      useEffect(() => {
        setEspecialidad('');
        setParalelo('');
      }, [anoGrado]);

      useEffect(() => {
        setParalelo('');
      }, [especialidad]);

      const handleLogin = async () => {
        setError('');
        setSuccess('');
        
        if (!email.trim() || !password.trim()) {
          setError('Por favor completa todos los campos');
          return;
        }

        if (userType === 'inspeccion') {
          const user = AUTHORIZED_USERS.find(u => u.email === email && u.password === password);
          if (user) {
            onLogin('inspeccion', email, { 
              nombre_completo: user.nombre, 
              email: user.email,
              nombreCompletoInspector: user.nombreCompleto 
            });
          } else {
            setError('Credenciales de inspecci√≥n incorrectas');
          }
          return;
        }

        if (!email.endsWith('@est.uepdc.edu.ec')) {
          setError('El correo debe terminar en @est.uepdc.edu.ec');
          return;
        }

        try {
          const users = await supabaseRequest(`usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&select=*`);
          
          if (!users || users.length === 0) {
            setError('Usuario no encontrado. Por favor reg√≠strate primero.');
            return;
          }

          const user = users[0];
          if (user.password !== password) {
            setError('Contrase√±a incorrecta');
            return;
          }

          onLogin('estudiante', email, user);
        } catch (err) {
          setError('Error al iniciar sesi√≥n: ' + err.message);
        }
      };

      const handleRegister = async () => {
        setError('');
        setSuccess('');
        
        if (!email.trim() || !password.trim() || !nombreCompleto.trim() || !cedula.trim() || !nivelEducativo || !anoGrado || !paralelo) {
          setError('Por favor completa todos los campos obligatorios');
          return;
        }

        // Validar especialidad para bachillerato
        if (nivelEducativo === 'bachillerato' && !especialidad) {
          setError('Por favor selecciona una especialidad para Bachillerato');
          return;
        }
        
        if (!email.endsWith('@est.uepdc.edu.ec')) {
          setError('El correo debe terminar en @est.uepdc.edu.ec');
          return;
        }

        try {
          const existing = await supabaseRequest(`usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&select=*`);
          if (existing && existing.length > 0) {
            setError('Este correo ya est√° registrado');
            return;
          }

          // Construir el curso completo en formato de base de datos
          const cursoCompleto = construirCursoCompleto();
          
          if (!cursoCompleto) {
            setError('Error al construir el curso. Por favor verifica los datos.');
            return;
          }

          const newUser = {
            email: email,
            password: password,
            nombre_completo: nombreCompleto,
            cedula: cedula,
            curso: cursoCompleto
          };

          await supabaseRequest('usuarios_estudiantes', 'POST', newUser);
          setSuccess('Registro exitoso. Ahora puedes iniciar sesi√≥n.');
          
          setEmail('');
          setPassword('');
          setNombreCompleto('');
          setCedula('');
          setNivelEducativo('');
          setAnoGrado('');
          setEspecialidad('');
          setParalelo('');
          
          setTimeout(() => {
            setShowRegister(false);
            setSuccess('');
          }, 2000);
        } catch (err) {
          setError('Error al registrar: ' + err.message);
        }
      };

      useEffect(() => { if (window.lucide) window.lucide.replace(); }, [error, success, userType, showRegister, nivelEducativo, anoGrado, especialidad]);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 via-blue-500 to-blue-700 flex items-center justify-center p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border-4 border-institutional-yellow hover-glow animate-slideIn">
            <div className="bg-gradient-to-r from-institutional-blue to-institutional-blue-dark p-8 relative overflow-hidden">
              <div className="absolute inset-0 bg-gradient-to-br from-blue-600/20 to-transparent"></div>
              <div className="text-center text-white relative z-10">
                <img src={LOGO_URL} alt="UEPDC Logo" className="w-24 h-24 mx-auto mb-4 animate-pulse-slow drop-shadow-2xl" />
                <h1 className="text-3xl font-bold drop-shadow-2xl animate-fadeIn" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.5)'}}>Sistema de Atrasos</h1>
                <p className="text-yellow-300 mt-2 font-bold text-lg drop-shadow-lg" style={{textShadow: '1px 1px 2px rgba(0,0,0,0.5)'}}>UEPDC</p>
              </div>
            </div>

            <div className="p-8">
              <div className="flex gap-2 mb-6">
                <button 
                  onClick={() => { setUserType('estudiante'); setShowRegister(false); }}
                  className={`flex-1 py-3 px-4 rounded-lg font-bold transition-all flex items-center justify-center gap-2 hover-scale ${
                    userType === 'estudiante' 
                      ? 'bg-gradient-to-r from-institutional-blue to-institutional-blue-dark text-white shadow-lg border-2 border-institutional-blue' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                  <span>Estudiante</span>
                </button>
                <button 
                  onClick={() => { setUserType('inspeccion'); setShowRegister(false); }}
                  className={`flex-1 py-3 px-4 rounded-lg font-bold transition-all flex items-center justify-center gap-2 hover-scale ${
                    userType === 'inspeccion' 
                      ? 'bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 shadow-lg border-2 border-institutional-yellow' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                  <span>Inspecci√≥n</span>
                </button>
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-50 border-2 border-red-300 rounded-lg text-red-700 text-sm flex items-center gap-2 animate-slideIn">
                  <i data-lucide="alert-circle" style={{width:18,height:18}}></i>
                  {error}
                </div>
              )}

              {success && (
                <div className="mb-4 p-3 bg-green-50 border-2 border-green-300 rounded-lg text-green-700 text-sm flex items-center gap-2 animate-slideIn">
                  <i data-lucide="check-circle" style={{width:18,height:18}}></i>
                  {success}
                </div>
              )}

              {userType === 'estudiante' && !showRegister ? (
                <div className="space-y-4 animate-fadeIn">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Correo Estudiantil</label>
                    <input 
                      type="email" 
                      value={email} 
                      onChange={(e) => setEmail(e.target.value.toLowerCase())}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="tu@est.uepdc.edu.ec"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow focus:border-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a</label>
                    <input 
                      type="password" 
                      value={password} 
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow focus:border-institutional-yellow transition-all"
                    />
                  </div>

                  <button 
                    onClick={handleLogin}
                    className="w-full bg-gradient-to-r from-institutional-blue to-institutional-blue-dark text-white py-3.5 rounded-lg font-bold hover:from-institutional-blue-dark hover:to-institutional-blue transition-all shadow-lg hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="log-in" style={{width:20,height:20}}></i>
                    Iniciar Sesi√≥n
                  </button>

                  <button 
                    onClick={() => setShowRegister(true)}
                    className="w-full bg-white border-2 border-institutional-blue text-institutional-blue py-3.5 rounded-lg font-bold hover:bg-blue-50 transition-all hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="user-check" style={{width:20,height:20}}></i>
                    Registrarse
                  </button>
                </div>
              ) : userType === 'estudiante' && showRegister ? (
                <div className="space-y-4 animate-fadeIn max-h-[60vh] overflow-y-auto pr-2">
                  {/* Datos Personales */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                      <i data-lucide="user" style={{width:16,height:16}} className="text-institutional-blue"></i>
                      Nombre Completo *
                    </label>
                    <input 
                      type="text" 
                      value={nombreCompleto} 
                      onChange={(e) => setNombreCompleto(e.target.value)}
                      placeholder="Ej: Juan Andr√©s P√©rez G√≥mez"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                      <i data-lucide="mail" style={{width:16,height:16}} className="text-institutional-blue"></i>
                      Correo Institucional *
                    </label>
                    <input 
                      type="email" 
                      value={email} 
                      onChange={(e) => setEmail(e.target.value.toLowerCase())}
                      placeholder="tuemail@est.uepdc.edu.ec"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                      <i data-lucide="credit-card" style={{width:16,height:16}} className="text-institutional-blue"></i>
                      C√©dula *
                    </label>
                    <input 
                      type="text" 
                      value={cedula} 
                      onChange={(e) => setCedula(e.target.value)}
                      placeholder="0123456789"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  {/* Informaci√≥n Acad√©mica */}
                  <div className="form-section-header">
                    <i data-lucide="book-open" style={{width:20,height:20}}></i>
                    Informaci√≥n Acad√©mica
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                      <i data-lucide="graduation-cap" style={{width:16,height:16}} className="text-institutional-blue"></i>
                      Nivel Educativo *
                    </label>
                    <select 
                      value={nivelEducativo} 
                      onChange={(e) => setNivelEducativo(e.target.value)}
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    >
                      <option value="">Selecciona el nivel</option>
                      {Object.entries(CURSOS_ESTRUCTURA).map(([key, nivel]) => (
                        <option key={key} value={key}>{nivel.nombre}</option>
                      ))}
                    </select>
                  </div>

                  {nivelEducativo && getAnoGradoOptions().length > 0 && (
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="calendar" style={{width:16,height:16}} className="text-institutional-blue"></i>
                        A√±o/Grado *
                      </label>
                      <select 
                        value={anoGrado} 
                        onChange={(e) => setAnoGrado(e.target.value)}
                        className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                      >
                        <option value="">Selecciona el grado</option>
                        {getAnoGradoOptions().map(option => (
                          <option key={option} value={option}>{option}</option>
                        ))}
                      </select>
                    </div>
                  )}

                  {nivelEducativo === 'bachillerato' && anoGrado && getEspecialidadesDisponibles().length > 0 && (
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="award" style={{width:16,height:16}} className="text-institutional-blue"></i>
                        Especialidad *
                      </label>
                      <select 
                        value={especialidad} 
                        onChange={(e) => setEspecialidad(e.target.value)}
                        className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                      >
                        <option value="">Selecciona la especialidad</option>
                        {getEspecialidadesDisponibles().map(esp => (
                          <option key={esp} value={esp}>
                            {esp === 'BGU Ciencias' ? 'üî¨ ' : esp === 'TICS Inform√°tica' ? 'üíª ' : 'üíº '}{esp}
                          </option>
                        ))}
                      </select>
                    </div>
                  )}

                  {((nivelEducativo !== 'bachillerato' && anoGrado) || (nivelEducativo === 'bachillerato' && especialidad)) && getParalelosDisponibles().length > 0 && (
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i data-lucide="users" style={{width:16,height:16}} className="text-institutional-blue"></i>
                        Paralelo *
                      </label>
                      <select 
                        value={paralelo} 
                        onChange={(e) => setParalelo(e.target.value)}
                        className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                      >
                        <option value="">Selecciona el paralelo</option>
                        {getParalelosDisponibles().map(p => (
                          <option key={p} value={p}>{p}</option>
                        ))}
                      </select>
                    </div>
                  )}

                  {/* Seguridad */}
                  <div className="form-section-header">
                    <i data-lucide="lock" style={{width:20,height:20}}></i>
                    Seguridad
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                      <i data-lucide="key" style={{width:16,height:16}} className="text-institutional-blue"></i>
                      Contrase√±a *
                    </label>
                    <input 
                      type="password" 
                      value={password} 
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow transition-all"
                    />
                  </div>

                  <button 
                    onClick={handleRegister}
                    className="w-full bg-gradient-to-r from-institutional-blue to-institutional-blue-dark text-white py-3.5 rounded-lg font-bold hover:from-institutional-blue-dark hover:to-institutional-blue transition-all shadow-lg hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="sparkles" style={{width:20,height:20}}></i>
                    Crear Cuenta
                  </button>

                  <button 
                    onClick={() => setShowRegister(false)}
                    className="w-full bg-white border-2 border-gray-300 text-gray-700 py-3.5 rounded-lg font-bold hover:bg-gray-50 transition-all hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="arrow-left" style={{width:20,height:20}}></i>
                    Volver a Iniciar Sesi√≥n
                  </button>
                </div>
              ) : (
                <div className="space-y-4 animate-fadeIn">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Correo de Inspecci√≥n</label>
                    <input 
                      type="email" 
                      value={email} 
                      onChange={(e) => setEmail(e.target.value.toLowerCase())}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="inspector@uepdc.edu.ec"
                      className="w-full border-2 border-institutional-yellow rounded-lg p-3 focus:ring-2 focus:ring-institutional-blue transition-all"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a</label>
                    <input 
                      type="password" 
                      value={password} 
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      className="w-full border-2 border-institutional-yellow rounded-lg p-3 focus:ring-2 focus:ring-institutional-blue transition-all"
                    />
                  </div>

                  <button 
                    onClick={handleLogin}
                    className="w-full bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 py-3.5 rounded-lg font-bold hover:from-institutional-yellow-dark hover:to-institutional-yellow transition-all shadow-lg hover-scale flex items-center justify-center gap-2"
                  >
                    <i data-lucide="shield-check" style={{width:20,height:20}}></i>
                    Iniciar Sesi√≥n
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // QR Scanner component
    function QRScanner({ onScan, onClose }) {
      const [isScanning, setIsScanning] = useState(false);
      const [error, setError] = useState('');
      const [capturedImage, setCapturedImage] = useState(null);
      const [showImageViewer, setShowImageViewer] = useState(false);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);
      const scanIntervalRef = useRef(null);

      const startCamera = async () => {
        try {
          setError('');
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            setIsScanning(true);
            // Iniciar escaneo autom√°tico en segundo plano
            startAutoScan();
          }
        } catch (err) {
          setError('No se pudo acceder a la c√°mara. Por favor, da permisos de c√°mara.');
        }
      };

      const stopCamera = () => {
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(t => t.stop());
          streamRef.current = null;
        }
        if (scanIntervalRef.current) {
          clearInterval(scanIntervalRef.current);
          scanIntervalRef.current = null;
        }
        setIsScanning(false);
      };

      const scanQRCode = () => {
        if (!videoRef.current || !canvasRef.current) return;
        
        const video = videoRef.current;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = window.jsQR ? window.jsQR(imageData.data, imageData.width, imageData.height) : null;

          if (code) {
            stopCamera();
            const qrData = code.data;
            const idMatch = qrData.match(/ID:(\d+)/i);
            const studentId = idMatch ? idMatch[1] : qrData;
            onScan(studentId);
          }
        }
      };

      const startAutoScan = () => {
        // Escaneo autom√°tico cada 300ms
        if (scanIntervalRef.current) {
          clearInterval(scanIntervalRef.current);
        }
        scanIntervalRef.current = setInterval(scanQRCode, 300);
      };

      const capturePhoto = () => {
        if (videoRef.current && canvasRef.current) {
          // Pausar escaneo autom√°tico mientras capturamos
          if (scanIntervalRef.current) {
            clearInterval(scanIntervalRef.current);
            scanIntervalRef.current = null;
          }
          
          const video = videoRef.current;
          const canvas = canvasRef.current;
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          // Convertir a imagen base64
          const imageDataUrl = canvas.toDataURL('image/png');
          setCapturedImage(imageDataUrl);
          setShowImageViewer(true);
          stopCamera();
        }
      };

      const processCapturedImage = () => {
        if (canvasRef.current) {
          const canvas = canvasRef.current;
          const ctx = canvas.getContext('2d');
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = window.jsQR ? window.jsQR(imageData.data, imageData.width, imageData.height) : null;
          
          if (code) {
            const qrData = code.data;
            const idMatch = qrData.match(/ID:(\d+)/i);
            const studentId = idMatch ? idMatch[1] : qrData;
            onScan(studentId);
          } else {
            setError('No se detect√≥ ning√∫n c√≥digo QR en la imagen. Intenta capturar nuevamente.');
          }
        }
      };

      const retakePhoto = () => {
        setCapturedImage(null);
        setShowImageViewer(false);
        setError('');
        startCamera();
      };

      useEffect(() => {
        startCamera();
        return () => stopCamera();
      }, []);

      useEffect(() => {
        if (window.lucide) window.lucide.replace();
      }, [isScanning, error, showImageViewer]);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden relative border-4 border-institutional-yellow animate-slideIn">
            <button 
              onClick={() => { stopCamera(); onClose(); }} 
              className="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 z-10 flex items-center justify-center"
              style={{width: '40px', height: '40px'}}
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div className="bg-institutional-blue p-4">
              <div className="flex items-center gap-2 text-white">
                <i data-lucide="qr-code" style={{width:24,height:24}}></i>
                <h2 className="text-xl font-bold">Escanear C√≥digo QR</h2>
              </div>
            </div>

            <div className="p-6">
              {error && <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm animate-slideIn flex items-center gap-2">
                <i data-lucide="alert-circle" style={{width:18,height:18}}></i>
                <span>{error}</span>
              </div>}

              {!showImageViewer ? (
                <>
                  {/* Vista de c√°mara en vivo - SIN ANIMACIONES */}
                  <div className="bg-black rounded-lg overflow-hidden border-4 border-institutional-yellow relative">
                    <div className="relative aspect-video">
                      <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" />
                    </div>
                  </div>

                  <canvas ref={canvasRef} className="hidden"></canvas>

                  {/* Solo bot√≥n para capturar foto */}
                  <div className="mt-4">
                    {isScanning && (
                      <button 
                        onClick={capturePhoto}
                        className="w-full bg-institutional-yellow text-gray-800 px-6 py-4 rounded-xl font-bold text-lg hover:bg-institutional-yellow-dark transition-all shadow-lg flex items-center justify-center gap-2 border-2 border-institutional-blue hover-scale"
                      >
                        <i data-lucide="camera" style={{width:24,height:24}}></i>
                        Capturar Foto
                      </button>
                    )}
                  </div>

                  <div className="mt-4 p-4 bg-blue-50 rounded-lg border-2 border-institutional-blue">
                    <p className="text-sm text-institutional-blue text-center flex items-center justify-center gap-2">
                      <i data-lucide="info" style={{width:18,height:18}}></i>
                      La c√°mara escanea autom√°ticamente. Tambi√©n puedes capturar una foto para revisarla.
                    </p>
                  </div>
                </>
              ) : (
                <>
                  {/* Visor de imagen capturada */}
                  <div className="mb-6">
                    <div className="relative bg-black rounded-xl overflow-hidden border-4 border-institutional-yellow shadow-2xl">
                      <img src={capturedImage} alt="Imagen capturada" className="w-full h-auto" />
                      <div className="absolute top-3 right-3 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                        <i data-lucide="check" style={{width:16,height:16}}></i>
                        Capturada
                      </div>
                    </div>
                  </div>

                  {/* Botones de acci√≥n para imagen capturada */}
                  <div className="flex gap-3">
                    <button 
                      onClick={retakePhoto}
                      className="flex-1 bg-gray-500 text-white px-6 py-4 rounded-xl font-semibold text-lg hover:bg-gray-600 transition-all shadow-lg flex items-center justify-center gap-2 hover-scale"
                    >
                      <i data-lucide="rotate-ccw" style={{width:22,height:22}}></i>
                      Tomar otra foto
                    </button>
                    <button 
                      onClick={processCapturedImage}
                      className="flex-1 bg-institutional-blue text-white px-6 py-4 rounded-xl font-semibold text-lg hover:bg-institutional-blue-dark transition-all shadow-lg flex items-center justify-center gap-2 border-2 border-institutional-yellow hover-scale"
                    >
                      <i data-lucide="scan" style={{width:22,height:22}}></i>
                      Procesar QR
                    </button>
                  </div>

                  <div className="mt-4 p-4 bg-blue-50 rounded-lg border-2 border-institutional-blue">
                    <p className="text-sm text-institutional-blue text-center flex items-center justify-center gap-2">
                      <i data-lucide="check-circle" style={{width:18,height:18}}></i>
                      Verifica que el c√≥digo QR sea visible y presiona "Procesar QR"
                    </p>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ManualInput component
    function ManualInput({ onSubmit, onClose }) {
      const [code, setCode] = useState('');
      
      useEffect(() => {
        if (window.lucide) window.lucide.replace();
      }, []);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border-4 border-institutional-yellow animate-slideIn">
            <div className="bg-institutional-blue p-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">Ingreso Manual</h2>
              <button onClick={onClose} className="text-white hover:bg-institutional-blue-dark rounded-lg p-2 hover-scale"><i data-lucide="x" style={{width:24,height:24}}></i></button>
            </div>
            <div className="p-6">
              <label className="block text-sm font-semibold text-gray-700 mb-2">Buscar por nombre, curso o ID</label>
              <input type="text" value={code} onChange={(e)=>setCode(e.target.value)} placeholder="Ej: Juan P√©rez, 1A, o ID del estudiante"
                className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow focus:border-institutional-yellow mb-4 transition-all"
                onKeyPress={(e)=> e.key==='Enter' && onSubmit(code.trim())}
              />
              <div className="flex gap-3">
                <button onClick={onClose} className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 hover-scale">Cancelar</button>
                <button onClick={()=>onSubmit(code.trim())} className="flex-1 bg-institutional-blue text-white py-3 rounded-lg font-semibold hover:bg-institutional-blue-dark hover-scale">Buscar</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // StudentModal component - SIN motivo ni archivo
    function StudentModal({ student, onConfirm, onClose, isSubmitting, userData }) {
      const recordedBy = userData?.nombreCompletoInspector || '';
      const ecuadorDateTime = getEcuadorDateTime();

      const handleConfirm = () => {
        if (recordedBy.trim()) {
          onConfirm(recordedBy);
        } else {
          alert('Error: No se pudo identificar al inspector');
        }
      };

      useEffect(()=> { if (window.lucide) window.lucide.replace(); }, [student, isSubmitting]);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden border-4 border-institutional-yellow max-h-[90vh] overflow-y-auto animate-slideIn">
            <div className="bg-institutional-yellow p-6 relative">
              <button onClick={onClose} className="absolute top-4 right-4 text-gray-700 hover:bg-institutional-yellow-dark rounded-lg p-2 hover-scale" disabled={isSubmitting}><i data-lucide="x" style={{width:24,height:24}}></i></button>
              <div className="flex items-center gap-3 text-gray-800">
                <div className="bg-white rounded-full p-3 animate-pulse-slow"><i data-lucide="user" style={{width:32,height:32}} className="text-institutional-blue"></i></div>
                <div>
                  <h2 className="text-2xl font-bold">Registro de Atraso</h2>
                  <p className="text-sm opacity-80">Confirmar informaci√≥n del estudiante</p>
                </div>
              </div>
            </div>

            <div className="p-6 space-y-4">
              <div className="bg-blue-50 border-l-4 border-institutional-blue p-4 rounded-r-lg animate-slideIn">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="user" style={{width:18,height:18}} className="text-institutional-blue"></i>
                  <span className="font-semibold text-gray-700">Nombre Completo</span>
                </div>
                <p className="text-lg font-bold text-gray-900">{student['Nombre completo estudiante']}</p>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-institutional-blue hover-glow transition-all">
                  <span className="text-sm text-gray-600">Curso</span>
                  <p className="font-semibold text-gray-900">{student.Curso}</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-institutional-blue hover-glow transition-all">
                  <span className="text-sm text-gray-600">Fecha</span>
                  <p className="font-semibold text-gray-900">{ecuadorDateTime.displayDate}</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg border-2 border-institutional-blue hover-glow transition-all">
                  <span className="text-sm text-gray-600">Hora</span>
                  <p className="font-semibold text-gray-900">{ecuadorDateTime.timeString}</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Registrado por</label>
                <div className="w-full border-2 border-institutional-yellow bg-yellow-50 rounded-lg p-3 flex items-center gap-2">
                  <i data-lucide="shield-check" style={{width:20,height:20}} className="text-gray-700"></i>
                  <span className="font-semibold text-gray-800">{recordedBy}</span>
                </div>
              </div>
            </div>

            <div className="bg-gray-50 p-6 flex gap-3">
              <button onClick={onClose} disabled={isSubmitting} className="flex-1 bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-100 flex items-center justify-center gap-2 hover-scale">
                <i data-lucide="x" style={{width:20,height:20}}></i> Cerrar
              </button>
              <button onClick={handleConfirm} disabled={isSubmitting} className="flex-1 bg-institutional-blue text-white py-3 rounded-lg font-semibold hover:bg-institutional-blue-dark flex items-center justify-center gap-2 hover-scale">
                <i data-lucide="check-circle" style={{width:20,height:20}}></i> {isSubmitting ? 'Guardando...' : 'Confirmar Atraso'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // FileViewerModal component
    function FileViewerModal({ fileData, onClose }) {
      useEffect(() => { if (window.lucide) window.lucide.replace(); }, []);

      const handleDownload = () => {
        if (!fileData || !fileData.data) return;
        
        const link = document.createElement('a');
        link.href = fileData.data;
        link.download = fileData.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const isImage = fileData && fileData.type && fileData.type.startsWith('image/');
      const isPDF = fileData && fileData.type && fileData.type === 'application/pdf';

      return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden border-4 border-institutional-yellow animate-slideIn relative">
            {/* Bot√≥n X para cerrar - Posicionado absolutamente */}
            <button 
              onClick={onClose} 
              className="absolute top-3 right-3 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 z-20"
              style={{width: '40px', height: '40px', boxShadow: '0 2px 8px rgba(0,0,0,0.3)'}}
              title="Cerrar"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>

            <div className="bg-institutional-blue p-4 flex items-center justify-between">
              <div className="flex items-center gap-2 text-white">
                <i data-lucide="file-text" style={{width:24,height:24}}></i>
                <h2 className="text-xl font-bold">Archivo Adjunto</h2>
              </div>
            </div>

            <div className="p-6 max-h-[70vh] overflow-y-auto">
              <div className="bg-blue-50 border-2 border-institutional-blue rounded-lg p-4 mb-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="bg-institutional-blue rounded-lg p-3">
                      <i data-lucide={isImage ? 'image' : isPDF ? 'file-text' : 'file'} style={{width:24,height:24}} className="text-white"></i>
                    </div>
                    <div>
                      <p className="font-bold text-gray-800">{fileData.name}</p>
                      <p className="text-sm text-gray-600">
                        {fileData.size ? `${(fileData.size / 1024).toFixed(2)} KB` : 'Tama√±o desconocido'}
                      </p>
                    </div>
                  </div>
                  {fileData.data && (
                    <button 
                      onClick={handleDownload}
                      className="bg-institutional-yellow text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-institutional-yellow-dark flex items-center gap-2 hover-scale"
                    >
                      <i data-lucide="download" style={{width:18,height:18}}></i>
                      Descargar
                    </button>
                  )}
                </div>
              </div>

              {fileData.data ? (
                <div className="border-4 border-institutional-yellow rounded-xl overflow-hidden bg-gray-100">
                  {isImage ? (
                    <img src={fileData.data} alt={fileData.name} className="w-full h-auto" />
                  ) : isPDF ? (
                    <iframe 
                      src={fileData.data} 
                      className="w-full h-[600px]"
                      title={fileData.name}
                    />
                  ) : (
                    <div className="p-8 text-center">
                      <i data-lucide="file" style={{width:64,height:64}} className="mx-auto mb-4 text-gray-400"></i>
                      <p className="text-gray-600">Vista previa no disponible para este tipo de archivo.</p>
                      <p className="text-sm text-gray-500 mt-2">Usa el bot√≥n "Descargar" para ver el archivo.</p>
                    </div>
                  )}
                </div>
              ) : (
                <div className="border-4 border-institutional-yellow rounded-xl p-8 text-center bg-gray-50">
                  <i data-lucide="alert-circle" style={{width:64,height:64}} className="mx-auto mb-4 text-orange-400"></i>
                  <p className="text-gray-600">Este archivo fue registrado en el formato antiguo.</p>
                  <p className="text-sm text-gray-500 mt-2">Solo se guard√≥ el nombre del archivo, no su contenido.</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // JustificationModal component - CON archivo
    function JustificationModal({ record, onClose, onSubmit, isSubmitting }) {
      const [justification, setJustification] = useState(record.motivo_atraso || '');
      const [selectedFile, setSelectedFile] = useState(null);

      const handleSubmit = async () => {
        if (!justification.trim()) {
          alert('Por favor ingresa el motivo de justificaci√≥n');
          return;
        }
        onSubmit(justification, selectedFile);
      };

      useEffect(() => { if (window.lucide) window.lucide.replace(); }, [selectedFile]);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden max-h-[90vh] overflow-y-auto border-4 border-institutional-yellow animate-slideIn">
            <div className="bg-institutional-blue p-6">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-bold text-white">Justificar Atraso</h2>
                <button onClick={onClose} disabled={isSubmitting} className="text-white hover:bg-institutional-blue-dark rounded-lg p-2 hover-scale">
                  <i data-lucide="x" style={{width:24,height:24}}></i>
                </button>
              </div>
            </div>

            <div className="p-6 space-y-4">
              <div className="bg-blue-50 border-l-4 border-institutional-blue p-4 rounded-r-lg animate-slideIn">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="user" style={{width:18,height:18}} className="text-institutional-blue"></i>
                  <span className="font-semibold text-gray-700">Estudiante</span>
                </div>
                <p className="text-lg font-bold text-gray-900">{record['Nombre completo estudiante']}</p>
                <div className="mt-2 text-sm text-gray-600">
                  <p><strong>Curso:</strong> {record.Curso}</p>
                  <p><strong>Fecha:</strong> {new Date(record.fecha_atraso + 'T00:00:00').toLocaleDateString('es-ES')}</p>
                  <p><strong>Hora:</strong> {record.hora_llegada}</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Motivo de Justificaci√≥n *</label>
                <textarea 
                  value={justification} 
                  onChange={(e) => setJustification(e.target.value)}
                  placeholder="Ingrese el motivo de la justificaci√≥n..."
                  className="w-full border-2 border-institutional-blue rounded-lg p-3 focus:ring-2 focus:ring-institutional-yellow resize-none transition-all"
                  rows={4}
                  disabled={isSubmitting}
                />
              </div>

              <FileUpload onFileSelect={setSelectedFile} selectedFile={selectedFile} />
            </div>

            <div className="bg-gray-50 p-6 flex gap-3">
              <button 
                onClick={onClose} 
                disabled={isSubmitting}
                className="flex-1 bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-100 hover-scale"
              >
                Cancelar
              </button>
              <button 
                onClick={handleSubmit}
                disabled={isSubmitting || !justification.trim()}
                className="flex-1 bg-institutional-blue text-white py-3 rounded-lg font-semibold hover:bg-institutional-blue-dark disabled:bg-gray-400 flex items-center justify-center gap-2 hover-scale"
              >
                {isSubmitting ? (
                  <>
                    <div className="spinner rounded-full h-5 w-5 border-b-2 border-white"></div>
                    Guardando...
                  </>
                ) : (
                  <>
                    <i data-lucide="check-circle" style={{width:20,height:20}}></i>
                    Justificar
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // AttendanceHistory component
    function AttendanceHistory({ records, loading, onRefresh, userRole, userData, onJustify }) {
      const [searchTerm, setSearchTerm] = useState('');
      const [dateFilter, setDateFilter] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');
      const [viewingFile, setViewingFile] = useState(null);

      const normalizeDate = (dateString) => {
        if (!dateString) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
        return dateString.split('T')[0];
      };

      // Funci√≥n helper para determinar si un registro est√° justificado
      const isJustified = (record) => {
        // Un registro est√° justificado si tiene "[ARCHIVO_ADJUNTO:" o "[Archivo adjunto:" en el motivo
        return record.motivo_atraso && (
          record.motivo_atraso.includes('[ARCHIVO_ADJUNTO:') || 
          record.motivo_atraso.includes('[Archivo adjunto:')
        );
      };

      // Funci√≥n para extraer el archivo adjunto del motivo
      const getAttachedFile = (motivo) => {
        if (!motivo) return null;
        
        // Buscar el formato nuevo con datos base64
        const newFormatMatch = motivo.match(/\[ARCHIVO_ADJUNTO:({.*?})\]/);
        if (newFormatMatch) {
          try {
            return JSON.parse(newFormatMatch[1]);
          } catch (e) {
            console.error('Error al parsear archivo adjunto:', e);
            return null;
          }
        }
        
        // Buscar el formato antiguo (solo nombre)
        const oldFormatMatch = motivo.match(/\[Archivo adjunto: (.*?)\]/);
        if (oldFormatMatch) {
          return { name: oldFormatMatch[1], data: null };
        }
        
        return null;
      };

      // Funci√≥n para obtener el motivo limpio (sin informaci√≥n del archivo)
      const getCleanMotivo = (motivo) => {
        if (!motivo) return 'Sin especificar';
        return motivo.replace(/\[ARCHIVO_ADJUNTO:.*?\]/, '').replace(/\[Archivo adjunto:.*?\]/, '').trim() || 'Sin especificar';
      };

      const filteredRecords = records.filter(record => {
        const matchesSearch = !searchTerm || 
          (record['Nombre completo estudiante']?.toLowerCase().includes(searchTerm.toLowerCase()) || 
           record.Curso?.toLowerCase().includes(searchTerm.toLowerCase()));
        
        let matchesDate = true;
        if (dateFilter) {
          const recordDateStr = normalizeDate(record.fecha_atraso);
          matchesDate = recordDateStr === dateFilter;
        }
        
        // Actualizar la l√≥gica de filtro por estado
        let matchesStatus = true;
        if (statusFilter === 'confirmado') {
          matchesStatus = record.estado === 'confirmado' && !isJustified(record);
        } else if (statusFilter === 'justificado') {
          matchesStatus = isJustified(record);
        }
        // Si statusFilter === 'all', matchesStatus permanece true
        
        const hasValidStatus = record.estado === 'confirmado';
        
        if (userRole === 'estudiante' && userData) {
          const studentNameInRecord = record['Nombre completo estudiante'];
          const loggedInStudentName = userData.nombre_completo;
          const matchesStudent = namesMatch(studentNameInRecord, loggedInStudentName);
          
          return matchesSearch && matchesDate && matchesStatus && hasValidStatus && matchesStudent;
        }
        
        return matchesSearch && matchesDate && matchesStatus && hasValidStatus;
      });

      useEffect(()=> { if (window.lucide) window.lucide.replace(); }, [records, searchTerm, dateFilter, statusFilter, loading]);

      const clearFilters = () => {
        setSearchTerm('');
        setDateFilter('');
        setStatusFilter('all');
      };

      return (
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden border-4 border-institutional-yellow animate-fadeIn">
          <div className="bg-institutional-yellow p-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-3 text-gray-800">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><path d="M20 8v6"></path><path d="M23 11h-6"></path></svg>
                <h2 className="text-2xl font-bold">Historial de Atrasos</h2>
              </div>
              <button onClick={onRefresh} className="bg-gradient-to-r from-white to-gray-50 text-institutional-blue px-5 py-2.5 rounded-lg font-bold hover:from-gray-50 hover:to-white flex items-center gap-2 border-2 border-institutional-blue hover-scale shadow-md transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"></path></svg>
                Actualizar
              </button>
            </div>
          </div>

          <div className="p-6 border-b-2 border-institutional-yellow bg-gray-50">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <input 
                type="text" 
                value={searchTerm} 
                onChange={(e)=>setSearchTerm(e.target.value)} 
                placeholder="Buscar por nombre o curso" 
                className="border-2 border-institutional-blue rounded-lg p-2 focus:ring-2 focus:ring-institutional-yellow transition-all" 
              />
              <input 
                type="date" 
                value={dateFilter} 
                onChange={(e)=>setDateFilter(e.target.value)} 
                className="border-2 border-institutional-blue rounded-lg p-2 focus:ring-2 focus:ring-institutional-yellow transition-all" 
              />
              <select 
                value={statusFilter} 
                onChange={(e)=>setStatusFilter(e.target.value)} 
                className="border-2 border-institutional-blue rounded-lg p-2 focus:ring-2 focus:ring-institutional-yellow transition-all"
              >
                <option value="all">Todos los estados</option>
                <option value="confirmado">Confirmados</option>
                <option value="justificado">Justificados</option>
              </select>
              <button 
                onClick={clearFilters}
                className="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-2 rounded-lg font-bold hover:from-gray-300 hover:to-gray-200 flex items-center justify-center gap-2 hover-scale shadow-sm border-2 border-gray-400"
              >
                <i data-lucide="filter-x" style={{width:20,height:20}}></i> Limpiar
              </button>
            </div>
          </div>

          <div className="p-6">
            {loading ? (
              <div className="text-center py-8">
                <div className="spinner rounded-full h-12 w-12 border-b-4 border-institutional-blue mx-auto"></div>
                <p className="mt-4 text-gray-600">Cargando historial...</p>
              </div>
            ) : (
              <>
                <div className="text-sm text-gray-600 mb-4 flex items-center gap-2 animate-slideIn">
                  <i data-lucide="database" style={{width:16,height:16}} className="text-institutional-blue"></i>
                  Mostrando {filteredRecords.length} de {records.filter(r => r.estado === 'confirmado').length} registros
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-institutional-blue text-white"><tr>
                      <th className="text-left p-3 text-sm font-semibold">Fecha</th>
                      <th className="text-left p-3 text-sm font-semibold">Estudiante</th>
                      <th className="text-left p-3 text-sm font-semibold">Curso</th>
                      <th className="text-left p-3 text-sm font-semibold">Hora</th>
                      <th className="text-left p-3 text-sm font-semibold">Motivo</th>
                      {userRole === 'inspeccion' && <th className="text-left p-3 text-sm font-semibold">Registrado por</th>}
                      <th className="text-left p-3 text-sm font-semibold">Estado</th>
                      {userRole === 'inspeccion' && <th className="text-left p-3 text-sm font-semibold">Acciones</th>}
                    </tr></thead>
                    <tbody>
                      {filteredRecords.length === 0 ? (
                        <tr><td colSpan={userRole === 'inspeccion' ? '8' : '6'} className="text-center py-8 text-gray-500">
                          <i data-lucide="search-x" style={{width:48,height:48}} className="mx-auto mb-2 text-gray-300 animate-bounce-slow"></i>
                          <p>No se encontraron registros de atrasos</p>
                        </td></tr>
                      ) : (
                        filteredRecords.map((record, index) => (
                          <tr key={record.N || index} className="border-b-2 border-gray-100 hover:bg-yellow-50 transition-all">
                            <td className="p-3 text-sm">{new Date(record.fecha_atraso + 'T00:00:00').toLocaleDateString('es-ES')}</td>
                            <td className="p-3 text-sm font-medium">{record['Nombre completo estudiante']}</td>
                            <td className="p-3 text-sm">{record.Curso}</td>
                            <td className="p-3 text-sm">
                              <span className="flex items-center gap-1">
                                <i data-lucide="clock" style={{width:14,height:14}} className="text-institutional-blue"></i>
                                {record.hora_llegada || 'N/A'}
                              </span>
                            </td>
                            <td className="p-3 text-sm text-gray-600">
                              <div className="flex items-center gap-2">
                                <span>{getCleanMotivo(record.motivo_atraso)}</span>
                                {getAttachedFile(record.motivo_atraso) && (
                                  <button
                                    onClick={() => setViewingFile(getAttachedFile(record.motivo_atraso))}
                                    className="bg-institutional-blue text-white px-2 py-1 rounded text-xs font-semibold hover:bg-institutional-blue-dark flex items-center gap-1 hover-scale"
                                    title="Ver archivo adjunto"
                                  >
                                    <i data-lucide="paperclip" style={{width:12,height:12}}></i>
                                    Ver archivo
                                  </button>
                                )}
                              </div>
                            </td>
                            {userRole === 'inspeccion' && <td className="p-3 text-sm text-gray-600">{record.registrado_por || 'N/A'}</td>}
                            <td className="p-3">
                              {isJustified(record) ? (
                                <span className="inline-flex items-center gap-1 bg-institutional-blue text-white px-3 py-1 rounded-full text-xs font-semibold">
                                  <i data-lucide="file-check" style={{width:14,height:14}}></i> Justificado
                                </span>
                              ) : record.estado === 'confirmado' ? (
                                <span className="inline-flex items-center gap-1 bg-institutional-yellow text-gray-800 px-3 py-1 rounded-full text-xs font-semibold border-2 border-institutional-blue">
                                  <i data-lucide="alert-circle" style={{width:14,height:14}}></i> Confirmado
                                </span>
                              ) : (
                                <span className="inline-flex items-center gap-1 bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs font-semibold">
                                  <i data-lucide="clock" style={{width:14,height:14}}></i> Pendiente
                                </span>
                              )}
                            </td>
                            {userRole === 'inspeccion' && (
                              <td className="p-3">
                                {!isJustified(record) ? (
                                  <button
                                    onClick={() => onJustify(record)}
                                    className="bg-institutional-blue text-white px-3 py-1 rounded-lg text-xs font-semibold hover:bg-institutional-blue-dark flex items-center gap-1 hover-scale"
                                  >
                                    <i data-lucide="file-edit" style={{width:12,height:12}}></i>
                                    Justificar
                                  </button>
                                ) : (
                                  <div className="justified-badge inline-flex items-center gap-2 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg hover-scale animate-fadeIn">
                                    <div className="justified-badge-icon rounded-full p-1">
                                      <i data-lucide="badge-check" style={{width:16,height:16}} className="text-emerald-600"></i>
                                    </div>
                                    <span className="tracking-wide" style={{textShadow: '0 1px 2px rgba(0,0,0,0.3)'}}>JUSTIFICADO</span>
                                  </div>
                                )}
                              </td>
                            )}
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </>
            )}
          </div>

          {viewingFile && <FileViewerModal fileData={viewingFile} onClose={() => setViewingFile(null)} />}
        </div>
      );
    }

    // Main App
    function App(){
      const [userRole, setUserRole] = useState(null);
      const [userEmail, setUserEmail] = useState('');
      const [userData, setUserData] = useState(null);
      const [view, setView] = useState('scanner');
      const [showScanner, setShowScanner] = useState(false);
      const [showManualInput, setShowManualInput] = useState(false);
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [notification, setNotification] = useState(null);
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(false);
      const [justificationRecord, setJustificationRecord] = useState(null);

      const handleLogin = (role, email, user) => {
        setUserRole(role);
        setUserEmail(email);
        setUserData(user);
        if (role === 'estudiante') {
          setView('history');
        }
      };

      const handleLogout = () => {
        setUserRole(null);
        setUserEmail('');
        setUserData(null);
        setView('scanner');
      };

      useEffect(()=> {
        if (view === 'history') loadAttendanceRecords();
      }, [view]);

      useEffect(()=> {
        if (window.lucide) window.lucide.replace();
      }, [view, showScanner, showManualInput, selectedStudent, notification, records, userRole, justificationRecord]);

      const showNotification = (type, message) => {
        setNotification({type, message});
        setTimeout(()=> setNotification(null), 4000);
      };

      const handleJustification = (record) => {
        setJustificationRecord(record);
      };

      const submitJustification = async (justification, file) => {
        setIsSubmitting(true);
        try {
          let fileData = null;
          
          // Convertir archivo a base64 si existe
          if (file) {
            const base64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            
            fileData = {
              name: file.name,
              size: file.size,
              type: file.type,
              data: base64
            };
          }

          // Guardar motivo y archivo en formato JSON
          const motivoTexto = fileData 
            ? `${justification} [ARCHIVO_ADJUNTO:${JSON.stringify(fileData)}]`
            : justification;

          const updateData = {
            motivo_atraso: motivoTexto
          };
          
          await supabaseRequest(`atrasos?N=eq.${justificationRecord.N}`, 'PATCH', updateData);
          
          showNotification('success', 'Justificaci√≥n guardada correctamente');
          setJustificationRecord(null);
          await loadAttendanceRecords();
        } catch (err) {
          console.error('Error al justificar:', err);
          showNotification('error', 'Error al guardar la justificaci√≥n: ' + err.message);
        } finally {
          setIsSubmitting(false);
        }
      };

      const findStudent = async (searchTerm) => {
        try {
          setIsSubmitting(true);
          
          // Validar que se haya ingresado texto
          if (!searchTerm || searchTerm.trim() === '') {
            showNotification('error', 'Ingrese el nombre del estudiante');
            setIsSubmitting(false);
            setShowScanner(false);
            setShowManualInput(false);
            return;
          }
          
          let students = [];

          if (!isNaN(searchTerm)) {
            const byId = await supabaseRequest(`atrasos?N=eq.${searchTerm}&select=*&limit=1`);
            if (byId && byId.length > 0) students = [byId[0]];
          }

          if (students.length === 0) {
            const byName = await supabaseRequest(`atrasos?or=(Nombre%20completo%20estudiante.ilike.*${encodeURIComponent(searchTerm)}*,Curso.ilike.*${encodeURIComponent(searchTerm)}*)&select=*&limit=1`);
            if (byName && byName.length > 0) students = [byName[0]];
          }

          if (!students || students.length === 0) {
            showNotification('error','Estudiante no encontrado');
            setIsSubmitting(false);
            setShowScanner(false);
            setShowManualInput(false);
            return;
          }

          const student = students[0];
          
          const ecuadorDateTime = getEcuadorDateTime();
          const today = ecuadorDateTime.dateString;
          
          const todayQuery = `Nombre%20completo%20estudiante=eq.${encodeURIComponent(student['Nombre completo estudiante'])}&fecha_atraso=eq.${today}&estado=in.(confirmado,justificado)`;
          const existingRecords = await supabaseRequest(`atrasos?${todayQuery}`);

          if (existingRecords && existingRecords.length > 0) {
            showNotification('error','Este estudiante ya tiene un registro de atraso hoy');
            setIsSubmitting(false);
            setShowScanner(false);
            setShowManualInput(false);
            return;
          }

          setSelectedStudent(student);
          setShowScanner(false);
          setShowManualInput(false);
          setIsSubmitting(false);
        } catch (err) {
          console.error('Error al buscar estudiante:', err);
          showNotification('error','Error al buscar estudiante: ' + err.message);
          setIsSubmitting(false);
          setShowScanner(false);
          setShowManualInput(false);
        }
      };

      const handleConfirmAttendance = async (recordedBy) => {
        setIsSubmitting(true);
        try {
          const ecuadorDateTime = getEcuadorDateTime();

          const newRecord = {
            'Nombre completo estudiante': selectedStudent['Nombre completo estudiante'],
            Curso: selectedStudent.Curso,
            'Email estudiante': selectedStudent['Email estudiante'] || null,
            fecha_atraso: ecuadorDateTime.dateString,
            hora_llegada: ecuadorDateTime.timeString,
            registrado_por: recordedBy,
            estado: 'confirmado'
          };
          
          await supabaseRequest(`atrasos`, 'POST', newRecord);
          showNotification('success', `Atraso confirmado para ${selectedStudent['Nombre completo estudiante']}`);
          setSelectedStudent(null);
          await loadAttendanceRecords();
        } catch (err) {
          console.error('Error al guardar:', err);
          showNotification('error','Error al registrar el atraso: ' + err.message);
        } finally {
          setIsSubmitting(false);
        }
      };

      const loadAttendanceRecords = async () => {
        setLoading(true);
        try {
          const allRecords = await supabaseRequest('atrasos?order=fecha_atraso.desc,hora_llegada.desc&estado=eq.confirmado&limit=1000');
          setRecords(allRecords || []);
        } catch (err) {
          console.error('Error al cargar registros:', err);
          showNotification('error','Error al cargar el historial: ' + err.message);
          setRecords([]);
        } finally {
          setLoading(false);
        }
      };

      if (!userRole) {
        return <Login onLogin={handleLogin} />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-yellow-50">
          <header className="bg-institutional-blue shadow-lg border-b-4 border-institutional-yellow">
            <div className="container mx-auto px-4 py-6">
              <div className="flex justify-between items-center flex-wrap gap-4">
                <div className="flex items-center gap-4">
                  <img src={LOGO_URL} alt="UEPDC Logo" className="logo-container" />
                  <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-white drop-shadow-lg flex items-center gap-3">
                      Sistema de Atrasos
                    </h1>
                    <p className="text-yellow-200 mt-1 font-semibold text-sm">
                      {userRole === 'inspeccion' ? 'üõ°Ô∏è Panel de Inspecci√≥n' : 'üë®‚Äçüéì Panel de Estudiantes'} - {userData?.nombreCompletoInspector || userData?.nombre_completo || userEmail}
                    </p>
                  </div>
                </div>
                <button 
                  onClick={handleLogout}
                  className="bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 px-6 py-2.5 rounded-lg font-bold hover:from-institutional-yellow-dark hover:to-institutional-yellow flex items-center gap-2 border-2 border-white hover-scale shadow-lg transition-all"
                >
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                  <span>Cerrar Sesi√≥n</span>
                </button>
              </div>
            </div>
          </header>

          {notification && (
            <div className="fixed top-4 right-4 z-50">
              <div className={`rounded-lg shadow-2xl p-4 flex items-center gap-3 max-w-md border-4 ${
                notification.type === 'success' 
                  ? 'bg-institutional-blue text-white border-institutional-yellow' 
                  : 'bg-red-500 text-white border-red-700'
              }`}>
                <i data-lucide={notification.type === 'success' ? 'check-circle' : 'alert-circle'} style={{width:24,height:24}}></i>
                <span className="font-semibold">{notification.message}</span>
              </div>
            </div>
          )}

          {userRole === 'inspeccion' && (
            <nav className="bg-white shadow-md sticky top-0 z-40 border-b-4 border-institutional-yellow">
              <div className="container mx-auto px-4">
                <div className="flex justify-center gap-3 py-4">
                  <button onClick={()=>setView('scanner')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all hover-scale ${view==='scanner' ? 'bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 shadow-lg border-2 border-institutional-blue' : 'bg-gray-100 text-gray-600 hover:bg-gray-200 border-2 border-gray-300'}`}>
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    Registrar Atraso
                  </button>
                  <button onClick={()=>setView('history')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all hover-scale ${view==='history' ? 'bg-gradient-to-r from-institutional-yellow to-institutional-yellow-dark text-gray-800 shadow-lg border-2 border-institutional-blue' : 'bg-gray-100 text-gray-600 hover:bg-gray-200 border-2 border-gray-300'}`}>
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4  4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><path d="M20 8v6"></path><path d="M23 11h-6"></path></svg>
                    Historial
                  </button>
                </div>
              </div>
            </nav>
          )}

          <main className="container mx-auto px-4 py-8">
            {view === 'scanner' && userRole === 'inspeccion' ? (
              <div className="max-w-2xl mx-auto animate-fadeIn">
                <div className="bg-white rounded-2xl shadow-lg p-8 md:p-12 border-4 border-institutional-yellow hover-glow">
                  <div className="text-center mb-8">
                    <img src={LOGO_URL} alt="UEPDC Logo" className="w-24 h-24 mx-auto mb-4 animate-pulse-slow" />
                    <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-3">Registrar Atraso Estudiantil</h2>
                    <p className="text-gray-600">Selecciona un m√©todo para identificar al estudiante</p>
                  </div>

                  <div className="space-y-4">
                    <button onClick={()=>setShowScanner(true)} className="w-full bg-institutional-blue text-white py-4 px-6 rounded-xl font-semibold hover:bg-institutional-blue-dark transition-all shadow-lg flex items-center justify-center gap-3 text-lg border-2 border-institutional-yellow hover-scale">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                      Escanear C√≥digo QR
                    </button>

                    <button onClick={()=>setShowManualInput(true)} className="w-full bg-institutional-yellow text-gray-800 py-4 px-6 rounded-xl font-semibold hover:bg-institutional-yellow-dark transition-all shadow-lg flex items-center justify-center gap-3 text-lg border-2 border-institutional-blue hover-scale">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="2" y1="17" x2="22" y2="17"></line></svg>
                      Ingreso Manual
                    </button>
                  </div>

                  <div className="mt-8 p-4 bg-blue-50 rounded-lg border-2 border-institutional-blue">
                    <p className="text-sm text-institutional-blue text-center flex items-center justify-center gap-2">
                      <i data-lucide="info" style={{width:18,height:18}}></i>
                      <strong>Nota:</strong> El sistema valida autom√°ticamente que no existan registros duplicados del mismo d√≠a
                    </p>
                  </div>
                </div>
              </div>
            ) : (
              <AttendanceHistory 
                records={records} 
                loading={loading} 
                onRefresh={loadAttendanceRecords} 
                userRole={userRole}
                userData={userData}
                onJustify={handleJustification}
              />
            )}
          </main>

          {showScanner && <QRScanner onScan={findStudent} onClose={()=>setShowScanner(false)} />}
          {showManualInput && <ManualInput onSubmit={findStudent} onClose={()=>setShowManualInput(false)} />}
          {selectedStudent && <StudentModal student={selectedStudent} onConfirm={handleConfirmAttendance} onClose={()=>setSelectedStudent(null)} isSubmitting={isSubmitting} userData={userData} />}
          {justificationRecord && <JustificationModal record={justificationRecord} onClose={()=>setJustificationRecord(null)} onSubmit={submitJustification} isSubmitting={isSubmitting} />}

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>

  <script>
    // Renderizar iconos Lucide m√∫ltiples veces para asegurar que todos se muestren
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 100);
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 500);
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 1000);
    setTimeout(()=> { if (window.lucide) window.lucide.replace(); }, 2000);
  </script>
</body>
</html>
